var brewBench=angular.module("brewbench",["ngCookies","ui.router","nvd3"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,e,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],t.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]);brewBench.filter("moment",function(){return function(t){return t?moment(new Date(t)).fromNow():""}}).filter("formatDegrees",["$filter",function(t){return function(e,n){return"F"==n?t("toFahrenheit")(e):t("toCelsius")(e)}}]).filter("toFahrenheit",function(){return function(t){return Math.round(9*t/5+32)}}).filter("toCelsius",function(){return function(t){return Math.round(5*(t-32)/9)}}),brewBench.factory("BrewService",["$http","$q","$filter","$cookies",function(t,e,n,i){return{settings:function(t,e){try{if(e)return i.put(t,JSON.stringify(e));if(i.get(t))return JSON.parse(i.get(t))}catch(n){}return e},byteCount:function(t){return encodeURI(t).split(/%..|./).length-1},domain:function(){return"localhost"==document.location.host?"http://arduino.local":""},readSensor:function(n,i){var r=e.defer();return t.get(this.domain()+"/arduino/"+n+"/"+i,{timeout:1e4}).then(function(t){r.resolve(t.data)},function(t){r.reject(t)}),r.promise},writeSensor:function(n,i,r){var o=e.defer();return t.get(this.domain()+"/arduino/"+n+"/"+i+"/"+r,{timeout:1e4}).then(function(t){o.resolve(t.data)},function(t){o.reject(t)}),o.promise},blink:function(n){var i=e.defer();return t.get(this.domain()+"/arduino/blink/"+n+"/output",{timeout:1e4}).then(function(t){i.resolve(t.data)},function(t){i.reject(t)}),i.promise},chartOptions:function(){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:450,margin:{top:20,right:20,bottom:100,left:65},x:function(t){return t[0]},y:function(t){return t[1]},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(t){return d3.time.format("%I:%M:%S")(new Date(t))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(t){return t},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]),brewBench.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BrewService",function(t,e,n,i,r,o,s,l){function a(e){if(e&&e.temp){var n=parseInt(e.pin);"F"==t.settings.unit?t.kettles[n].currentTemp=i("toFahrenheit")(e.temp):t.kettles[n].currentTemp=Math.round(e.temp),t.kettles[n].values.length>c&&t.kettles.map(function(t){return t.values=[]});var r=new Date;t.kettles[n].values.push([r.getTime(),t.kettles[n].currentTemp]),t.kettles[n].currentTemp>=t.kettles[n].targetTemp+t.kettles[n].diff?(t.kettles[n].high=t.kettles[n].currentTemp-t.kettles[n].targetTemp,t.kettles[n].low=null,t.tempAlert(t.kettles[n])):t.kettles[n].currentTemp<=t.kettles[n].targetTemp-t.kettles[n].diff?(t.kettles[n].low=t.kettles[n].targetTemp-t.kettles[n].currentTemp,t.kettles[n].high=null,t.tempAlert(t.kettles[n])):(t.kettles[n].targetHit=new Date,t.kettles[n].low=null,t.kettles[n].high=null)}}var u=null,c=25;t.settings=l.settings("settings")||{pollSeconds:10,unit:"F",sound:!0,notifications:!0},t.chartOptions=l.chartOptions(),t.kettles=l.settings("kettles")||[{key:"Boil",targetTemp:200,targetHit:null,currentTemp:0,diff:5,active:!1,low:null,high:null,timer:{min:60,sec:0,running:!1},values:[]},{key:"Hot Liquor",targetTemp:175,targetHit:null,currentTemp:0,diff:5,active:!1,low:null,high:null,values:[]},{key:"Mash",targetTemp:150,targetHit:null,currentTemp:0,diff:2,active:!1,low:null,high:null,timer:{min:60,sec:0,running:!1},values:[]}],t.tempAlert=function(e){if(!e||e.targetHit){if("vibrate"in navigator&&navigator.vibrate([500,300,500]),t.settings.sound===!0){var n=new Audio("audio/error.mp3");n.play()}if(t.settings.notifications&&"Notification"in window){var i,r="img/brewmachine-45.png";e&&e.high?i="Your "+e.key+" kettle is "+e.high+" degrees too hot":e&&e.low?i="Your "+e.key+" kettle is "+e.low+" degrees too cold":e||(i="Testing Alerts, you are ready to go, click play on a kettle."),u&&u.close(),"granted"===Notification.permission?i&&(u=new Notification("BrewMachine",{body:i,icon:r})):"denied"!==Notification.permission&&Notification.requestPermission(function(t){"granted"===t&&i&&(u=new Notification("BrewMachine",{body:i,icon:r}))})}}},t.changeUnits=function(e){for(k in t.kettles)t.kettles[k].currentTemp=i("formatDegrees")(t.kettles[k].currentTemp,e),t.kettles[k].targetTemp=i("formatDegrees")(t.kettles[k].targetTemp,e),t.kettles[k].diff=i("formatDegrees")(t.kettles[k].diff,e)},t.timerRun=function(e){t.kettles[e].interval=o(function(){0==t.kettles[e].timer.min&&0==t.kettles[e].timer.sec?o.cancel(t.kettles[e].interval):t.kettles[e].timer.sec>0?t.kettles[e].timer.sec--:(t.kettles[e].timer.sec=59,t.kettles[e].timer.min--)},1e3)},t.timerStart=function(e){t.kettles[e].timer.running?(t.kettles[e].timer.running=!1,o.cancel(t.kettles[e].interval)):(t.kettles[e].timer.running=!0,t.timerRun(e))},t.processTemps=function(){var e=[];for(k in t.kettles)t.kettles[k].active&&e.push(l.readSensor("analog",k).then(a));s.all(e).then(function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)},function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)})},t.changeValue=function(e,n,i){i?t.kettles[e][n]++:t.kettles[e][n]--},t.processTemps(),t.tempAlert();for(k in t.kettles)t.kettles[k].timer&&t.kettles[k].timer.running&&t.timerRun(k);t.$watchCollection("settings",function(t,e){l.settings("settings",t)}),t.$watch("kettles",function(t,e){l.settings("kettles",t)},!0)}]);