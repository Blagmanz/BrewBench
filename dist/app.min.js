var brewBench=angular.module("brewbench",["ui.router","nvd3","ngTouch"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],e.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]);brewBench.filter("moment",function(){return function(e){return e?moment(new Date(e)).fromNow():""}}).filter("formatDegrees",["$filter",function(e){return function(t,n){return"F"==n?e("toFahrenheit")(t):e("toCelsius")(t)}}]).filter("toFahrenheit",function(){return function(e){return Math.round(9*e/5+32)}}).filter("toCelsius",function(){return function(e){return Math.round(5*(e-32)/9)}}).directive("editable",function(){return{restrict:"E",scope:{model:"="},replace:!1,template:'<span><input type="text" ng-model="model" ng-show="edit" ng-enter="edit=false"></input><span ng-show="!edit">{{model}}</span></span>',link:function(e,t,n){e.edit=!1,t.bind("click",function(){e.$apply(e.edit=!0)})}}}).directive("ngEnter",function(){return function(e,t,n){t.bind("keypress",function(t){(13===t.charCode||13===t.keyCode)&&e.$apply(n.ngEnter)})}}),brewBench.factory("BrewService",["$http","$q","$filter",function(e,t,n){return{settings:function(e,t){if(!window.localStorage)return t;try{if(t)return window.localStorage.setItem(e,JSON.stringify(t));if(window.localStorage.getItem(e))return JSON.parse(window.localStorage.getItem(e))}catch(n){}return t},byteCount:function(e){return encodeURI(e).split(/%..|./).length-1},domain:function(){var e=this.settings("settings");return e&&e.arduinoUrl?e.arduinoUrl:"localhost"==document.location.host?"http://arduino.local":""},temp:function(n,i){var r=t.defer(),o=this.domain()+"/arduino/analog/"+n;return i&&(o+="/"+i),e.get(o,{timeout:1e4}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},heat:function(n,i){var r=t.defer(),o=this.domain()+"/arduino/digital/"+n;return i&&(o+="/"+i),e.get(o,{timeout:1e4}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},blink:function(n){var i=t.defer();return e.get(this.domain()+"/arduino/blink/"+n+"/output",{timeout:1e4}).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},chartOptions:function(){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:450,margin:{top:20,right:20,bottom:100,left:65},x:function(e){return e[0]},y:function(e){return e[1]},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(e){return d3.time.format("%I:%M:%S")(new Date(e))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(e){return e},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]),brewBench.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BrewService",function(e,t,n,i,r,o,a,l){function u(t){if(t&&t.temp){var n=e.kettles.filter(function(e){return e.pin==parseInt(t.pin)})[0];"F"==e.settings.unit?n.currentTemp=i("toFahrenheit")(t.temp):n.currentTemp=Math.round(t.temp),n.values.length>c&&e.kettles.map(function(e){return e.values=[]});var r=new Date;n.values.push([r.getTime(),n.currentTemp]),n.currentTemp>=n.targetTemp+n.diff?(n.high=n.currentTemp-n.targetTemp,n.low=null,e.tempAlert(n),n.heater.on===!0&&n.heater.running&&l.heat(n.heater.pin,0).then(function(){n.heater.running=null},function(e){})):n.currentTemp<=n.targetTemp-n.diff?(n.low=n.targetTemp-n.currentTemp,n.high=null,e.tempAlert(n),n.heater.on!==!0||n.heater.running||l.heat(n.heater.pin,1).then(function(){n.heater.running=new Date},function(e){})):(n.targetHit=new Date,n.low=null,n.high=null,n.heater.on===!0&&n.heater.running&&l.heat(n.heater.pin,0).then(function(){n.heater.running=null},function(e){}))}}var s=null,c=100;e.chartOptions=l.chartOptions(),e.settings=l.settings("settings")||{pollSeconds:10,unit:"F",sound:!0,notifications:!0,arduinoUrl:"http://arduino.local",storage:"sd"},e.kettles=l.settings("kettles")||[{key:"Boil",pin:0,targetTemp:200,targetHit:null,currentTemp:0,diff:5,active:!1,low:null,high:null,heater:{pin:2,on:!1,running:!1},timer:{min:60,sec:0,running:!1},volume:5,values:[]},{key:"Hot Liquor",pin:1,targetTemp:175,targetHit:null,currentTemp:0,diff:5,active:!1,low:null,high:null,heater:{pin:3,on:!1,running:!1},volume:5,values:[]},{key:"Mash",pin:2,targetTemp:150,targetHit:null,currentTemp:0,diff:2,active:!1,low:null,high:null,heater:{pin:4,on:!1,running:!1},timer:{min:60,sec:0,running:!1},volume:5,values:[]}],e.addKettle=function(){e.kettles.length<5&&e.kettles.unshift({key:"New Kettle",pin:e.kettles.length,targetTemp:150,targetHit:null,currentTemp:0,diff:2,active:!1,low:null,high:null,heater:{pin:5,on:!1,running:!1},volume:5,values:[]})},e.startStopKettle=function(e){e.active=!e.active,!e.active&&e.heater.running&&l.heat(e.heater.pin,0).then(function(){e.heater.running=null,e.heater.on=!1},function(e){})},e.startStopKettleHeat=function(e){e.heater.on=!e.heater.on,!e.heater.on&&e.heater.running&&l.heat(e.heater.pin,0).then(function(){e.heater.running=null},function(e){})},e.tempAlert=function(t){if(!t||t.targetHit){if("vibrate"in navigator&&navigator.vibrate([500,300,500]),e.settings.sound===!0){var n=new Audio("audio/error.mp3");n.play()}if(e.settings.notifications&&"Notification"in window){var i,r="img/brewbench-logo-45.png";t&&t.high?i="Your "+t.key+" kettle is "+t.high+" degrees too hot":t&&t.low?i="Your "+t.key+" kettle is "+t.low+" degrees too cold":t||(i="Testing Alerts, you are ready to go, click play on a kettle."),s&&s.close(),"granted"===Notification.permission?i&&(s=new Notification("BrewBench",{body:i,icon:r})):"denied"!==Notification.permission&&Notification.requestPermission(function(e){"granted"===e&&i&&(s=new Notification("BrewBench",{body:i,icon:r}))})}}},e.changeUnits=function(t){for(k in e.kettles)e.kettles[k].currentTemp=i("formatDegrees")(e.kettles[k].currentTemp,t),e.kettles[k].targetTemp=i("formatDegrees")(e.kettles[k].targetTemp,t),e.kettles[k].diff=i("formatDegrees")(e.kettles[k].diff,t)},e.timerRun=function(t){e.kettles[t].interval=o(function(){0==e.kettles[t].timer.min&&0==e.kettles[t].timer.sec?o.cancel(e.kettles[t].interval):e.kettles[t].timer.sec>0?e.kettles[t].timer.sec--:(e.kettles[t].timer.sec=59,e.kettles[t].timer.min--)},1e3)},e.timerStart=function(t){e.kettles[t].timer.running?(e.kettles[t].timer.running=!1,o.cancel(e.kettles[t].interval)):(e.kettles[t].timer.running=!0,e.timerRun(t))},e.processTemps=function(){var t=[];for(k in e.kettles)e.kettles[k].active&&t.push(l.temp(e.kettles[k].pin).then(u));a.all(t).then(function(t){r(function(){e.processTemps()},1e3*e.settings.pollSeconds)},function(t){r(function(){e.processTemps()},1e3*e.settings.pollSeconds)})},e.changeValue=function(t,n,i){i?e.kettles[t][n]++:e.kettles[t][n]--},e.processTemps(),e.tempAlert();for(k in e.kettles)e.kettles[k].timer&&e.kettles[k].timer.running&&e.timerRun(k);e.$watchCollection("settings",function(e,t){l.settings("settings",e)}),e.$watch("kettles",function(e,t){l.settings("kettles",e)},!0)}]);