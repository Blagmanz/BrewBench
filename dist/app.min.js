var brewMachine=angular.module("brewmachine",["ngCookies","ui.router","nvd3"]);brewMachine.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],e.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]),brewMachine.filter("moment",function(){return function(e){return e?moment(new Date(e)).fromNow():""}}).filter("formatDegrees",["$filter",function(e){return function(t,n){return"F"==n?e("toFahrenheit")(t):e("toCelsius")(t)}}]).filter("toFahrenheit",function(){return function(e){return Math.round(9*e/5+32)}}).filter("toCelsius",function(){return function(e){return Math.round(5*(e-32)/9)}}),brewMachine.factory("BMService",["$http","$q","$filter","$cookies","Base64",function(e,t,n,r,i){return{auth:function(t){var n=i.encode("root:"+t);e.defaults.headers.common.Authorization="Basic "+n},settings:function(e,t){try{if(t)return r.put(e,JSON.stringify(t));if(r.get(e))return JSON.parse(r.get(e))}catch(n){}return t},byteCount:function(e){return encodeURI(e).split(/%..|./).length-1},domain:function(){return"localhost"==document.location.host?"http://arduino.local":""},readSensor:function(n,r){var i=t.defer();return e.get(this.domain()+"/arduino/"+n+"/"+r,{timeout:1e4}).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},writeSensor:function(n,r,i){var o=t.defer();return e.get(this.domain()+"/arduino/"+n+"/"+r+"/"+i,{timeout:1e4}).then(function(e){o.resolve(e.data)},function(e){o.reject(e)}),o.promise},blink:function(n){var r=t.defer();return e.get(this.domain()+"/arduino/blink/"+n+"/output",{timeout:1e4}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},chartOptions:function(){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:450,margin:{top:20,right:20,bottom:100,left:65},x:function(e){return e[0]},y:function(e){return e[1]},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(e){return d3.time.format("%I:%M:%S")(new Date(e))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(e){return e},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]).factory("Base64",function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var n,r,i,o,a,s="",l="",c="",u=0;do n=t.charCodeAt(u++),r=t.charCodeAt(u++),l=t.charCodeAt(u++),i=n>>2,o=(3&n)<<4|r>>4,a=(15&r)<<2|l>>6,c=63&l,isNaN(r)?a=c=64:isNaN(l)&&(c=64),s=s+e.charAt(i)+e.charAt(o)+e.charAt(a)+e.charAt(c),n=r=l="",i=o=a=c="";while(u<t.length);return s},decode:function(t){var n,r,i,o,a,s="",l="",c="",u=0,f=/[^A-Za-z0-9\+\/\=]/g;f.exec(t)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do i=e.indexOf(t.charAt(u++)),o=e.indexOf(t.charAt(u++)),a=e.indexOf(t.charAt(u++)),c=e.indexOf(t.charAt(u++)),n=i<<2|o>>4,r=(15&o)<<4|a>>2,l=(3&a)<<6|c,s+=String.fromCharCode(n),64!=a&&(s+=String.fromCharCode(r)),64!=c&&(s+=String.fromCharCode(l)),n=r=l="",i=o=a=c="";while(u<t.length);return s}}}),brewMachine.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BMService",function(e,t,n,r,i,o,a,s){function l(t){if(t&&t.temp){var n=parseInt(t.pin.replace("A",""));"F"==e.settings.unit?e.kettles[n].currentTemp=r("toFahrenheit")(t.temp):e.kettles[n].currentTemp=Math.round(t.temp),e.kettles[n].values.length>u&&e.kettles.map(function(e){return e.values=[]});var i=new Date;e.kettles[n].values.push([i.getTime(),e.kettles[n].currentTemp]),e.kettles[n].currentTemp>=e.kettles[n].targetTemp+e.kettles[n].diff?(e.kettles[n].high=e.kettles[n].currentTemp-e.kettles[n].targetTemp,e.kettles[n].low=null,e.tempAlert(e.kettles[n])):e.kettles[n].currentTemp<=e.kettles[n].targetTemp-e.kettles[n].diff?(e.kettles[n].low=e.kettles[n].targetTemp-e.kettles[n].currentTemp,e.kettles[n].high=null,e.tempAlert(e.kettles[n])):(e.kettles[n].low=null,e.kettles[n].high=null)}}var c=null,u=25;e.settings=s.settings("settings")||{pollSeconds:10,unit:"F",sound:!0,notifications:!0},e.chartOptions=s.chartOptions(),e.kettles=s.settings("kettles")||[{key:"Boil",targetTemp:200,currentTemp:0,diff:5,active:!1,low:null,high:null,timer:{min:60,sec:0,running:!1},values:[]},{key:"Hot Liquor",targetTemp:175,currentTemp:0,diff:5,active:!1,low:null,high:null,values:[]},{key:"Mash",targetTemp:150,currentTemp:0,diff:2,active:!1,low:null,high:null,timer:{min:60,sec:0,running:!1},values:[]}],e.tempAlert=function(t){if("vibrate"in navigator&&navigator.vibrate([500,300,500]),e.settings.sound===!0){var n=new Audio("audio/error.mp3");n.play()}if(e.settings.notifications&&"Notification"in window){var r,i="img/brewmachine-45.png";t&&t.high?r="Your "+t.key+" kettle is "+t.high+" degrees too hot":t&&t.low?r="Your "+t.key+" kettle is "+t.low+" degrees too cold":t||(r="Testing Alerts, you are ready to go, click play on a kettle."),c&&c.close(),"granted"===Notification.permission?r&&(c=new Notification("BrewMachine",{body:r,icon:i})):"denied"!==Notification.permission&&Notification.requestPermission(function(e){"granted"===e&&r&&(c=new Notification("BrewMachine",{body:r,icon:i}))})}},e.changeUnits=function(t){for(k in e.kettles)e.kettles[k].currentTemp=r("formatDegrees")(e.kettles[k].currentTemp,t),e.kettles[k].targetTemp=r("formatDegrees")(e.kettles[k].targetTemp,t),e.kettles[k].diff=r("formatDegrees")(e.kettles[k].diff,t)},e.timerRun=function(t){e.kettles[t].interval=o(function(){0==e.kettles[t].timer.min&&0==e.kettles[t].timer.sec?o.cancel(e.kettles[t].interval):e.kettles[t].timer.sec>0?e.kettles[t].timer.sec--:(e.kettles[t].timer.sec=59,e.kettles[t].timer.min--)},1e3)},e.timerStart=function(t){e.kettles[t].timer.running?(e.kettles[t].timer.running=!1,o.cancel(e.kettles[t].interval)):(e.kettles[t].timer.running=!0,e.timerRun(t))},e.processTemps=function(){var t=[];for(k in e.kettles)e.kettles[k].active&&t.push(s.readSensor("analog",k).then(l));a.all(t).then(function(t){i(function(){e.processTemps()},1e3*e.settings.pollSeconds)},function(t){i(function(){e.processTemps()},1e3*e.settings.pollSeconds)})},e.changeValue=function(t,n,r){r?e.kettles[t][n]++:e.kettles[t][n]--},e.processTemps(),e.tempAlert(),e.$watchCollection("settings",function(e,t){s.settings("settings",e)}),e.$watch("kettles",function(e,t){s.settings("kettles",e)},!0)}]);