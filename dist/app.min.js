var brewBench=angular.module("brewbench",["ui.router","nvd3","ngTouch","duScroll","ui.knob"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],e.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]);brewBench.filter("moment",function(){return function(e){return e?moment(new Date(e)).fromNow():""}}).filter("formatDegrees",["$filter",function(e){return function(t,n){return"F"==n?e("toFahrenheit")(t):e("toCelsius")(t)}}]).filter("toFahrenheit",function(){return function(e){return Math.round(9*e/5+32)}}).filter("toCelsius",function(){return function(e){return Math.round(5*(e-32)/9)}}).directive("editable",function(){return{restrict:"E",scope:{model:"=",type:"@?"},replace:!1,template:'<span><input type="{{type}}" ng-model="model" ng-show="edit" ng-enter="edit=false" class="editable"></input><span ng-show="!edit">{{model}}</span></span>',link:function(e,t,n){e.edit=!1,e.type=e.type?e.type:"text",t.bind("click",function(){e.$apply(e.edit=!0)})}}}).directive("ngEnter",function(){return function(e,t,n){t.bind("keypress",function(t){(13===t.charCode||13===t.keyCode)&&e.$apply(n.ngEnter)})}}).directive("onReadFile",["$parse",function(e){return{restrict:"A",scope:!1,link:function(t,n,i){var r=e(i.onReadFile);n.on("change",function(e){var n=new FileReader;n.onload=function(e){t.$apply(function(){r(t,{$fileContent:e.target.result})})},n.readAsText((e.srcElement||e.target).files[0])})}}}]),brewBench.factory("BrewService",["$http","$q","$filter",function(e,t,n){return{clear:function(){window.localStorage&&(window.localStorage.removeItem("settings"),window.localStorage.removeItem("kettles"))},settings:function(e,t){if(!window.localStorage)return t;try{if(t)return window.localStorage.setItem(e,JSON.stringify(t));if(window.localStorage.getItem(e))return JSON.parse(window.localStorage.getItem(e))}catch(n){}return t},byteCount:function(e){return encodeURI(e).split(/%..|./).length-1},domain:function(){var e=this.settings("settings");return e&&e.arduinoUrl?e.arduinoUrl:"localhost"==document.location.host?"http://arduino.local":""},temp:function(n,i){var r=t.defer(),a=this.domain()+"/arduino/temp/"+n;return i&&(a+="/"+i),e.get(a,{timeout:1e4}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},digital:function(n,i){var r=t.defer(),a=this.domain()+"/arduino/digital/"+n+"/"+i;return e.get(a,{timeout:1e4}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},digitalRead:function(n){var i=t.defer(),r=this.domain()+"/arduino/digital/"+n;return e.get(r,{timeout:1e4}).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},grains:function(){var n=t.defer();return e.get("/data/grains.json").then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},hops:function(){var n=t.defer();return e.get("/data/hops.json").then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},lovibond:function(){var n=t.defer();return e.get("/data/lovibond.json").then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},chartOptions:function(){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:450,margin:{top:20,right:20,bottom:100,left:65},x:function(e){return e[0]||e},y:function(e){return e[1]},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(e){return d3.time.format("%I:%M:%S")(new Date(e))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(e){return e+"°"},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]),brewBench.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BrewService",function(e,t,n,i,r,a,o,u){function s(t){if(e.error_message="",t&&t.temp){var n=e.kettles.filter(function(e){return e.pin==parseInt(t.pin)})[0];if(!n.active)return;"F"==e.settings.unit?n.temp.current=i("toFahrenheit")(t.temp):n.temp.current=Math.round(t.temp),n.values.length>p&&e.kettles.map(function(e){return e.values=[]});var r=new Date;n.values.push([r.getTime(),n.temp.current]),e.updateKnobCopy(n),n.temp.current>=n.temp.target+n.temp.diff?(e.alert(n),n.heater.auto&&n.heater.running&&u.digital(n.heater.pin,1).then(function(){n.heater.running=!1},function(e){}),n.pump.auto&&n.pump.running&&u.digital(n.pump.pin,1).then(function(){n.pump.running=!1},function(e){})):n.temp.current<=n.temp.target-n.temp.diff?(e.alert(n),n.heater.auto&&!n.heater.running&&u.digital(n.heater.pin,0).then(function(){n.heater.running=!0,n.knob.subText.text="heating",n.knob.subText.color="rgba(200,47,47,1)"},function(e){}),n.pump.auto&&!n.pump.running&&u.digital(n.pump.pin,0).then(function(){n.pump.running=!0},function(e){})):n.temp.hit=new Date}}var c=null,p=100,l=null;e.hops,e.grains,e.lovibond,e.chartOptions=u.chartOptions(),e.error_message="",e.getLovibondColor=function(t){if(t=t.replace(/°/g,"").replace(/ /g,""),-1!==t.indexOf("-")){var n=t.split("-");t=(parseFloat(n[0])+parseFloat(n[1]))/2}else t=parseFloat(t);if(!t)return"";var i=_.filter(e.lovibond,function(e){return e.srm<=t?e.hex:""});return i.length?i[i.length-1].hex:""},e.settings=u.settings("settings")||{pollSeconds:10,unit:"F",sound:!0,notifications:!0,arduinoUrl:"http://arduino.local",storage:"sd",recipe:{name:"Best Ale",yeast:[]}},e.knobOptions={readOnly:!0,unit:"°",subText:{enabled:!0,text:"",color:"gray",font:"auto"},trackWidth:40,barWidth:25,barCap:25,trackColor:"#ddd",barColor:"#777",dynamicOptions:!0,displayPrevious:!0,prevBarColor:"#777"},e.kettles=u.settings("kettles")||[{key:"Boil",type:"hop",pin:0,active:!1,heater:{pin:2,running:!1,auto:!1},pump:{pin:3,running:!1,auto:!1},temp:{hit:!1,current:0,target:200,diff:5},values:[],timers:[],knob:angular.merge(e.knobOptions,{value:0,min:0,max:205})},{key:"Hot Liquor",type:"water",pin:1,active:!1,heater:{pin:4,running:!1,auto:!1},pump:{pin:5,running:!1,auto:!1},temp:{hit:!1,current:0,target:200,diff:5},values:[],timers:[],knob:angular.merge(e.knobOptions,{value:0,min:0,max:205})},{key:"Mash",type:"grain",pin:2,active:!1,heater:{pin:6,running:!1,auto:!1},pump:{pin:7,running:!1,auto:!1},temp:{hit:!1,current:0,target:150,diff:5},values:[],timers:[],knob:angular.merge(e.knobOptions,{value:0,min:0,max:155})}],e.addKettle=function(){e.kettles.length<5&&e.kettles.push({key:"New Kettle",type:"water",pin:e.kettles.length,active:!1,heater:{pin:6,running:!1,auto:!1},pump:{pin:7,running:!1,auto:!1},temp:{hit:!1,current:0,target:150,diff:5},values:[],timers:[],knob:angular.merge(e.knobOptions,{value:0,min:0,max:155})})},e.showContent=function(t){var n=new X2JS,i=n.xml_str2json(t.replace(/&ldquo;/g,'"').replace(/&rdquo;/g,'"').replace(/&rsquo;/g,"'"));if(e.settings.recipe&&(e.settings.recipe={name:"",yeast:[]}),i.Recipes&&i.Recipes.Data.Recipe){if(i.Recipes.Data.Recipe.F_R_NAME&&(e.settings.recipe.name=i.Recipes.Data.Recipe.F_R_NAME),i.Recipes.Data.Recipe.Ingredients.Data.Grain){var r=_.filter(e.kettles,{type:"grain"})[0];r&&(r.timers=[],_.each(i.Recipes.Data.Recipe.Ingredients.Data.Grain,function(t){e.addTimer(r,{label:t.F_G_NAME,min:parseInt(t.F_G_BOIL_TIME,10),notes:t.F_G_AMOUNT/16+" lbs."})}))}if(i.Recipes.Data.Recipe.Ingredients.Data.Hops){var r=_.filter(e.kettles,{type:"hop"})[0];r&&(r.timers=[],_.each(i.Recipes.Data.Recipe.Ingredients.Data.Hops,function(t){e.addTimer(r,{label:t.F_H_NAME,min:parseInt(t.F_H_DRY_HOP_TIME,10)>0?null:parseInt(t.F_H_BOIL_TIME,10),notes:parseInt(t.F_H_DRY_HOP_TIME,10)>0?"Dry Hop "+parseFloat(t.F_H_AMOUNT).toFixed(2)+" oz. for "+parseInt(t.F_H_DRY_HOP_TIME,10)+" Days":parseFloat(t.F_H_AMOUNT).toFixed(2)+" oz."})}))}i.Recipes.Data.Recipe.Ingredients.Data.Misc&&(i.Recipes.Data.Recipe.Ingredients.Data.Misc.length?_.each(i.Recipes.Data.Recipe.Ingredients.Data.Misc,function(t){e.addTimer(r,{label:t.F_M_NAME+" "+parseFloat(t.F_M_AMOUNT).toFixed(2),min:parseInt(t.F_M_TIME,10)})}):e.addTimer(r,{label:i.Recipes.Data.Recipe.Ingredients.Data.Misc.F_M_NAME+" "+parseFloat(i.Recipes.Data.Recipe.Ingredients.Data.Misc.F_M_AMOUNT).toFixed(2)+" oz.",min:parseInt(i.Recipes.Data.Recipe.Ingredients.Data.Misc.F_M_TIME,10)})),i.Recipes.Data.Recipe.Ingredients.Data.Yeast&&(i.Recipes.Data.Recipe.Ingredients.Data.Yeast.length?_.each(i.Recipes.Data.Recipe.Ingredients.Data.Yeast,function(t){e.settings.recipe.yeast.push({name:t.F_Y_LAB+" "+t.F_Y_PRODUCT_ID})}):e.settings.recipe.yeast.push({name:i.Recipes.Data.Recipe.Ingredients.Data.Yeast.F_Y_LAB+" "+i.Recipes.Data.Recipe.Ingredients.Data.Yeast.F_Y_PRODUCT_ID}))}},e.init=function(){e.grains||u.grains().then(function(t){e.grains=_.sortBy(_.uniqBy(t,"name"),"name")}),e.hops||u.hops().then(function(t){e.hops=_.sortBy(_.uniqBy(t,"name"),"name")}),e.lovibond||u.lovibond().then(function(t){e.lovibond=t});for(k in e.kettles)e.kettles[k].knob.max=e.kettles[k].temp.target+e.kettles[k].temp.diff,u.digitalRead(e.kettles[k].heater.pin).then(function(t){"0"==t.value?(e.kettles[k].active=!0,e.kettles[k].heater.running=!0):e.kettles[k].heater.running=!1},function(e){}),u.digitalRead(e.kettles[k].pump.pin).then(function(t){"0"==t.value?(e.kettles[k].active=!0,e.kettles[k].pump.running=!0):e.kettles[k].pump.running=!1},function(e){}),e.updateKnobCopy(e.kettles[k])},e.getNavOffset=function(){return 20+angular.element(document.getElementById("navbar"))[0].offsetHeight},e.addTimer=function(e,t){e.timers||(e.timers=[]),t?(t.running=!1,e.timers.push(t)):e.timers.push({label:"Edit label",min:60,sec:0,running:!1})},e.toggleKettle=function(e,t){var n=t.heater;"pump"==e&&(n=t.pump),n.running=!n.running,t.active&&n.running?u.digital(n.pin,0).then(function(){},function(e){}):n.running||u.digital(n.pin,1).then(function(){},function(e){})},e.startStopKettle=function(t){t.active=!t.active,t.active&&(u.temp(t.pin).then(s,function(t){e.error_message="Could not connect to the Arduino at "+u.domain()}),t.knob.subText.text="starting..."),!t.active&&t.heater.running&&u.digital(t.heater.pin,1).then(function(){t.heater.running=!1,e.updateKnobCopy(t)},function(e){}),!t.active&&t.pump.running&&u.digital(t.pump.pin,1).then(function(){t.pump.running=!1,e.updateKnobCopy(t)},function(e){}),t.active||(t.pump.auto=!1,t.heater.auto=!1,e.updateKnobCopy(t))},e.clearKettles=function(){u.clear()},e.alert=function(t,n){if(n||!t||t.temp.hit){if("vibrate"in navigator&&navigator.vibrate([500,300,500]),e.settings.sound===!0){if("timer"!=n&&t&&t.low&&t.heater.running)return;var i=new Audio("audio/error.mp3");i.play()}if(e.settings.notifications===!0&&"Notification"in window){var r,a="img/brewbench-logo-45.png";if(t&&t.low&&t.heater.running)return;n&&"timer"==n?r="Your "+t.label+" timer is up":t&&t.high?r="Your "+t.key+" kettle is "+t.high+" degrees high":t&&t.low?r="Your "+t.key+" kettle is "+t.low+" degrees low":t||(r="Testing Alerts, you are ready to go, click play on a kettle."),c&&c.close(),"granted"===Notification.permission?r&&(c=new Notification("BrewBench",{body:r,icon:a})):"denied"!==Notification.permission&&Notification.requestPermission(function(e){"granted"===e&&r&&(c=new Notification("BrewBench",{body:r,icon:a}))})}}},e.updateKnobCopy=function(e){return e.active?void(e.temp.current>=e.temp.target+e.temp.diff?(e.knob.barColor="rgba(255,0,0,.6)",e.knob.trackColor="rgba(255,0,0,.1)",e.high=e.temp.current-e.temp.target,e.low=null,e.knob.subText.text=e.high+"° high",e.knob.subText.color="gray"):e.temp.current<=e.temp.target-e.temp.diff?(e.knob.barColor="rgba(52,152,219,.5)",e.knob.trackColor="rgba(52,152,219,.1)",e.low=e.temp.target-e.temp.current,e.high=null,e.heater.running?(e.knob.subText.text="heating",e.knob.subText.color="rgba(255,0,0,.6)"):(e.knob.subText.text=e.low+"° low",e.knob.subText.color="gray")):(e.knob.barColor="rgba(44,193,133,.6)",e.knob.trackColor="rgba(44,193,133,.1)",e.knob.subText.text="within target",e.knob.subText.color="gray",e.low=null,e.high=null)):(e.knob.subText.text="not running",e.knob.trackColor="#ddd",void(e.knob.barColor="#777"))},e.changeKettleType=function(e){"hop"==e.type?e.type="water":"grain"==e.type?e.type="hop":"water"==e.type&&(e.type="grain")},e.changeUnits=function(t){for(k in e.kettles)e.kettles[k].temp.current=i("formatDegrees")(e.kettles[k].temp.current,t),e.kettles[k].temp.target=i("formatDegrees")(e.kettles[k].temp.target,t),e.kettles[k].temp.diff=i("formatDegrees")(e.kettles[k].temp.diff,t)},e.timerRun=function(t){t.interval=a(function(){t.up||0!=t.min||0!=t.sec?!t.up&&t.sec>0?t.sec--:t.up&&t.up.sec<59?t.up.sec++:t.up?t.up&&(t.up.sec=0,t.up.min++):(t.sec=59,t.min--):(a.cancel(t.interval),e.alert(t,"timer"),t.up={min:0,sec:0,running:!0},e.timerRun(t))},1e3)},e.timerStart=function(t){t.up&&t.up.running?(t.up.running=!1,a.cancel(t.up.interval)):t.running?(t.running=!1,a.cancel(t.interval)):(t.running=!0,e.timerRun(t))},e.processTemps=function(){var t=[];for(k in e.kettles)e.kettles[k].active&&t.push(u.temp(e.kettles[k].pin).then(s,function(t){e.error_message="Could not connect to the Arduino at "+u.domain()}));o.all(t).then(function(t){r(function(){e.processTemps()},1e3*e.settings.pollSeconds)},function(t){r(function(){e.processTemps()},1e3*e.settings.pollSeconds)})},e.changeValue=function(t,n,i){l&&r.cancel(l),i?t.temp[n]++:t.temp[n]--,l=r(function(){t.knob.max=t.temp.target+t.temp.diff,e.updateKnobCopy(t)},1e3)},e.processTemps(),e.alert(),e.init();for(k in e.kettles)e.kettles[k].timer&&e.kettles[k].timer.running&&e.timerRun(k);e.$watchCollection("settings",function(e,t){u.settings("settings",e)}),e.$watch("kettles",function(e,t){u.settings("kettles",e)},!0)}]);