var brewBench=angular.module("brewbench",["ui.router","nvd3","ngTouch","duScroll","ui.knob"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,e,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],t.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("arduino",{url:"/arduino/:domain",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]);brewBench.filter("moment",function(){return function(t){return t?moment(new Date(t)).fromNow():""}}).filter("formatDegrees",["$filter",function(t){return function(e,n){return"F"==n?t("toFahrenheit")(e):t("toCelsius")(e)}}]).filter("toFahrenheit",function(){return function(t){return Math.round(9*t/5+32)}}).filter("toCelsius",function(){return function(t){return Math.round(5*(t-32)/9)}}).directive("editable",function(){return{restrict:"E",scope:{model:"=",type:"@?",trim:"@?"},replace:!1,template:'<span><input type="{{type}}" ng-model="model" ng-show="edit" ng-enter="edit=false" class="editable"></input><span ng-show="!edit">{{(trim) ? (model | limitTo:trim)+"..." : model}}</span></span>',link:function(t,e,n){t.edit=!1,t.type=t.type?t.type:"text",e.bind("click",function(){t.$apply(t.edit=!0)})}}}).directive("ngEnter",function(){return function(t,e,n){e.bind("keypress",function(e){(13===e.charCode||13===e.keyCode)&&t.$apply(n.ngEnter)})}}).directive("onReadFile",["$parse",function(t){return{restrict:"A",scope:!1,link:function(e,n,i){var r=t(i.onReadFile);n.on("change",function(t){var n=new FileReader;n.onload=function(t){e.$apply(function(){r(e,{$fileContent:t.target.result})})},n.readAsText((t.srcElement||t.target).files[0])})}}}]),brewBench.factory("BrewService",["$http","$q","$filter",function(t,e,n){return{clear:function(){window.localStorage&&(window.localStorage.removeItem("settings"),window.localStorage.removeItem("kettles"))},settings:function(t,e){if(!window.localStorage)return e;try{if(e)return window.localStorage.setItem(t,JSON.stringify(e));if(window.localStorage.getItem(t))return JSON.parse(window.localStorage.getItem(t))}catch(n){}return e},byteCount:function(t){return encodeURI(t).split(/%..|./).length-1},domain:function(t){var e=this.settings("settings"),n="";return e&&e.arduinoUrl?n=-1===e.arduinoUrl.indexOf("//")?"//"+e.arduinoUrl:e.arduinoUrl:"localhost"==document.location.host&&(n="//arduino.local"),t&&-1!==n.indexOf("//")?n.substring(n.indexOf("//")+2):n},slack:function(n,i,r,o,a){var s=e.defer(),u={attachments:[{fallback:i,title:a.key+" kettle",title_link:"http://"+document.location.host+"/#/arduino/"+this.domain(!0),fields:[{value:i}],color:r,mrkdwn_in:["text","fallback","fields"],thumb_url:o}]};return t({url:n,method:"POST",data:"payload="+JSON.stringify(u),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){s.resolve(t.data)},function(t){s.reject(t)}),s.promise},temp:function(n,i){var r=e.defer(),o=this.domain()+"/arduino/temp/"+n;return i&&(o+="/"+i),t.get(o,{timeout:1e4}).then(function(t){r.resolve(t.data)},function(t){r.reject(t)}),r.promise},digital:function(n,i){var r=e.defer(),o=this.domain()+"/arduino/digital/"+n+"/"+i;return t.get(o,{timeout:1e4}).then(function(t){r.resolve(t.data)},function(t){r.reject(t)}),r.promise},digitalRead:function(n){var i=e.defer(),r=this.domain()+"/arduino/digital/"+n;return t.get(r,{timeout:1e4}).then(function(t){i.resolve(t.data)},function(t){i.reject(t)}),i.promise},grains:function(){var n=e.defer();return t.get("/data/grains.json").then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},hops:function(){var n=e.defer();return t.get("/data/hops.json").then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},water:function(){var n=e.defer();return t.get("/data/water.json").then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},lovibond:function(){var n=e.defer();return t.get("/data/lovibond.json").then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},chartOptions:function(t){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:350,margin:{top:20,right:20,bottom:100,left:65},x:function(t){return t&&t.length?t[0]:t},y:function(t){return t&&t.length?t[1]:t},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(t){return d3.time.format("%I:%M:%S")(new Date(t))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:t&&"F"!=t?[-17,104]:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(t){return t+"°"},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]),brewBench.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BrewService",function(t,e,n,i,r,o,a,s){function u(e){if(t.error_message="",e&&e.temp){var n=_.filter(t.kettles,{pin:parseInt(e.pin)})[0];if(!n.active)return;"F"==t.settings.unit?n.temp.current=i("toFahrenheit")(e.temp):n.temp.current=Math.round(e.temp),n.values.length>c&&t.kettles.map(function(t){return t.values=[]});var r=new Date;n.values.push([r.getTime(),n.temp.current]),t.updateKnobCopy(n),n.temp.current>=n.temp.target+n.temp.diff?(t.alert(n),n.heater.auto&&n.heater.running&&s.digital(n.heater.pin,1).then(function(){n.heater.running=!1},function(t){}),n.pump.auto&&n.pump.running&&s.digital(n.pump.pin,1).then(function(){n.pump.running=!1},function(t){})):n.temp.current<=n.temp.target-n.temp.diff?(t.alert(n),n.heater.auto&&!n.heater.running&&s.digital(n.heater.pin,0).then(function(){n.heater.running=!0,n.knob.subText.text="heating",n.knob.subText.color="rgba(200,47,47,1)"},function(t){}),n.pump.auto&&!n.pump.running&&s.digital(n.pump.pin,0).then(function(){n.pump.running=!0},function(t){})):(n.temp.hit=new Date,t.alert(n))}}var l=null,c=100,p=null;t.hops,t.grains,t.water,t.lovibond,t.chartOptions=s.chartOptions(),t.error_message="",t.getLovibondColor=function(e){if(e=e.replace(/°/g,"").replace(/ /g,""),-1!==e.indexOf("-")){var n=e.split("-");e=(parseFloat(n[0])+parseFloat(n[1]))/2}else e=parseFloat(e);if(!e)return"";var i=_.filter(t.lovibond,function(t){return t.srm<=e?t.hex:""});return i.length?i[i.length-1].hex:""},t.settings=s.settings("settings")||{pollSeconds:10,unit:"F",arduinoUrl:"arduino.local",storage:"sd",recipe:{name:"",yeast:[]},notifications:{on:!0,timers:!0,high:!0,low:!0,target:!0,slack:"Slack notification webhook Url",last:""},sounds:{on:!0,alert:"audio/bike.mp3",timer:"audio/school.mp3"}},e.domain&&(t.settings.arduinoUrl=e.domain),t.knobOptions={readOnly:!0,unit:"°",subText:{enabled:!0,text:"",color:"gray",font:"auto"},trackWidth:40,barWidth:25,barCap:25,trackColor:"#ddd",barColor:"#777",dynamicOptions:!0,displayPrevious:!0,prevBarColor:"#777"},t.kettles=s.settings("kettles")||[{key:"Boil",type:"hop",pin:0,active:!1,heater:{pin:2,running:!1,auto:!1},pump:{pin:3,running:!1,auto:!1},temp:{hit:!1,current:0,target:200,diff:5},values:[],timers:[],knob:angular.merge(t.knobOptions,{value:0,min:0,max:205})},{key:"Hot Liquor",type:"water",pin:1,active:!1,heater:{pin:4,running:!1,auto:!1},pump:{pin:5,running:!1,auto:!1},temp:{hit:!1,current:0,target:200,diff:5},values:[],timers:[],knob:angular.merge(t.knobOptions,{value:0,min:0,max:205})},{key:"Mash",type:"grain",pin:2,active:!1,heater:{pin:6,running:!1,auto:!1},pump:{pin:7,running:!1,auto:!1},temp:{hit:!1,current:0,target:150,diff:5},values:[],timers:[],knob:angular.merge(t.knobOptions,{value:0,min:0,max:155})}],t.addKettle=function(){t.kettles.length<5&&t.kettles.push({key:"New Kettle",type:"water",pin:t.kettles.length,active:!1,heater:{pin:6,running:!1,auto:!1},pump:{pin:7,running:!1,auto:!1},temp:{hit:!1,current:0,target:150,diff:5},values:[],timers:[],knob:angular.merge(t.knobOptions,{value:0,min:0,max:155})})},t.activeKettles=function(){return _.filter(t.kettles,{active:!0}).length},t.showContent=function(e){var n=new X2JS,i=n.xml_str2json(e.replace(/&ldquo;/g,'"').replace(/&rdquo;/g,'"').replace(/&rsquo;/g,"'").replace(/&ndash;/g,"-"));t.settings.recipe&&(t.settings.recipe={name:"",yeast:[]});var r=null;if(i&&(i.Recipes&&i.Recipes.Data.Recipe?r=i.Recipes.Data.Recipe:i.Selections&&i.Selections.Data.Recipe&&(r=i.Selections.Data.Recipe)),r){if(r.F_R_NAME&&(t.settings.recipe.name=r.F_R_NAME),r.F_R_STYLE.F_S_CATEGORY&&(t.settings.recipe.category=r.F_R_STYLE.F_S_CATEGORY),r.F_R_STYLE.F_S_MAX_ABV&&r.F_R_STYLE.F_S_MIN_ABV?t.settings.recipe.abv=parseFloat(r.F_R_STYLE.F_S_MIN_ABV).toFixed(2)+" - "+parseFloat(r.F_R_STYLE.F_S_MAX_ABV).toFixed(2):r.F_R_STYLE.F_S_MAX_ABV?t.settings.recipe.abv=parseFloat(r.F_R_STYLE.F_S_MAX_ABV).toFixed(2):r.F_R_STYLE.F_S_MIN_ABV&&(t.settings.recipe.abv=parseFloat(r.F_R_STYLE.F_S_MIN_ABV).toFixed(2)),r.Ingredients.Data.Grain){var o=_.filter(t.kettles,{type:"grain"})[0];o&&(o.timers=[],_.each(r.Ingredients.Data.Grain,function(e){t.addTimer(o,{label:e.F_G_NAME,min:parseInt(e.F_G_BOIL_TIME,10),notes:parseFloat(e.F_G_AMOUNT/16).toFixed(2)+" lbs."})}))}if(r.Ingredients.Data.Hops){var o=_.filter(t.kettles,{type:"hop"})[0];o&&(o.timers=[],_.each(r.Ingredients.Data.Hops,function(e){t.addTimer(o,{label:e.F_H_NAME,min:parseInt(e.F_H_DRY_HOP_TIME,10)>0?null:parseInt(e.F_H_BOIL_TIME,10),notes:parseInt(e.F_H_DRY_HOP_TIME,10)>0?"Dry Hop "+parseFloat(e.F_H_AMOUNT).toFixed(2)+" oz. for "+parseInt(e.F_H_DRY_HOP_TIME,10)+" Days":parseFloat(e.F_H_AMOUNT).toFixed(2)+" oz."})}))}o&&r.Ingredients.Data.Misc&&(r.Ingredients.Data.Misc.length?_.each(r.Ingredients.Data.Misc,function(e){t.addTimer(o,{label:e.F_M_NAME+" "+parseFloat(e.F_M_AMOUNT).toFixed(2),min:parseInt(e.F_M_TIME,10)})}):t.addTimer(o,{label:r.Ingredients.Data.Misc.F_M_NAME+" "+parseFloat(r.Ingredients.Data.Misc.F_M_AMOUNT).toFixed(2)+" oz.",min:parseInt(r.Ingredients.Data.Misc.F_M_TIME,10)})),r.Ingredients.Data.Yeast&&(r.Ingredients.Data.Yeast.length?_.each(r.Ingredients.Data.Yeast,function(e){t.settings.recipe.yeast.push({name:e.F_Y_LAB+" "+e.F_Y_PRODUCT_ID})}):t.settings.recipe.yeast.push({name:r.Ingredients.Data.Yeast.F_Y_LAB+" "+r.Ingredients.Data.Yeast.F_Y_PRODUCT_ID})),t.recipe_success=!0}else t.recipe_success=!1},t.init=function(){t.grains||s.grains().then(function(e){t.grains=_.sortBy(_.uniqBy(e,"name"),"name")}),t.hops||s.hops().then(function(e){t.hops=_.sortBy(_.uniqBy(e,"name"),"name")}),t.water||s.water().then(function(e){t.water=_.sortBy(_.uniqBy(e,"name"),"name")}),t.lovibond||s.lovibond().then(function(e){t.lovibond=e}),_.each(t.kettles,function(e){e.knob.max=e.temp.target+e.temp.diff,s.digitalRead(e.heater.pin).then(function(t){"0"==t.value?(e.active=!0,e.heater.running=!0):e.heater.running=!1},function(t){}),s.digitalRead(e.pump.pin).then(function(t){"0"==t.value?(e.active=!0,e.pump.running=!0):e.pump.running=!1},function(t){}),e.timers&&e.timers.length&&_.each(e.timers,function(n){n.running?(n.running=!1,t.timerStart(n,e)):!n.running&&n.queue?r(function(){t.timerStart(n,e)},6e4):n.up&&n.up.running&&(n.up.running=!1,t.timerStart(n.up))}),t.updateKnobCopy(e)})},t.getNavOffset=function(){return 55+angular.element(document.getElementById("navbar"))[0].offsetHeight},t.addTimer=function(t,e){t.timers||(t.timers=[]),e?(e.min=e.min?e.min:0,e.sec=e.sec?e.sec:0,e.running=e.running?e.running:!1,e.queue=e.queue?e.queue:!1,t.timers.push(e)):t.timers.push({label:"Edit label",min:60,sec:0,running:!1,queue:!1})},t.toggleKettle=function(t,e){var n=e.heater;"pump"==t&&(n=e.pump),n.running=!n.running,e.active&&n.running?s.digital(n.pin,0).then(function(){},function(t){}):n.running||s.digital(n.pin,1).then(function(){},function(t){})},t.startStopKettle=function(e){e.active=!e.active,e.active&&(s.temp(e.pin).then(u,function(e){t.error_message="Could not connect to the Arduino at "+s.domain()}),e.knob.subText.text="starting..."),!e.active&&e.heater.running&&s.digital(e.heater.pin,1).then(function(){e.heater.running=!1,t.updateKnobCopy(e)},function(t){}),!e.active&&e.pump.running&&s.digital(e.pump.pin,1).then(function(){e.pump.running=!1,t.updateKnobCopy(e)},function(t){}),e.active||(e.pump.auto=!1,e.heater.auto=!1,t.updateKnobCopy(e))},t.clearKettles=function(t,e){angular.element(t.target).html("Removing..."),s.clear(),r(function(){window.location.reload()},1e3)},t.alert=function(e,n){if((n||!e||e.temp.hit)&&t.settings.notifications.on!==!1){var i,r="https://brewbench.io/img/brewbench-logo.png",o="good";if(-1!==["hop","grain","water"].indexOf(e.type)&&(r="https://brewbench.io/img/"+e.type+".png"),!(e&&e.low&&e.heater.running)){if(n){if(!t.settings.notifications.timers)return;i=n.up?"Your timers are done":n.notes?"Time to add "+n.notes+" of "+n.label:"Time to add "+n.label}else if(e&&e.high){if(!t.settings.notifications.high||"high"==t.settings.notifications.last)return;i="Your "+e.key+" kettle is "+e.high+"° high",o="danger",t.settings.notifications.last="high"}else if(e&&e.low){if(!t.settings.notifications.low||"low"==t.settings.notifications.last)return;i="Your "+e.key+" kettle is "+e.low+"° low",o="#3498DB",t.settings.notifications.last="low"}else if(e){if(!t.settings.notifications.target||"target"==t.settings.notifications.last)return;i="Your "+e.key+" kettle is within the target at "+e.temp.current+"°",o="good",t.settings.notifications.last="target"}else e||(i="Testing Alerts, you are ready to go, click play on a kettle.");if("vibrate"in navigator&&navigator.vibrate([500,300,500]),t.settings.sounds.on===!0){if(n&&e&&e.low&&e.heater.running)return;var a=new Audio(n?t.settings.sounds.timer:t.settings.sounds.alert);a.play()}"Notification"in window&&(l&&l.close(),"granted"===Notification.permission?i&&(l=new Notification(e.key+" kettle",{body:i,icon:r})):"denied"!==Notification.permission&&Notification.requestPermission(function(t){"granted"===t&&i&&(l=new Notification(e.key+" kettle",{body:i,icon:r}))})),-1!==t.settings.notifications.slack.indexOf("http")&&s.slack(t.settings.notifications.slack,i,o,r,e).then(function(t){})}}},t.updateKnobCopy=function(t){return t.active?void(t.temp.current>=t.temp.target+t.temp.diff?(t.knob.barColor="rgba(255,0,0,.6)",t.knob.trackColor="rgba(255,0,0,.1)",t.high=t.temp.current-t.temp.target,t.low=null,t.knob.subText.text=t.high+"° high",t.knob.subText.color="rgba(255,0,0,.6)"):t.temp.current<=t.temp.target-t.temp.diff?(t.knob.barColor="rgba(52,152,219,.5)",t.knob.trackColor="rgba(52,152,219,.1)",t.low=t.temp.target-t.temp.current,t.high=null,t.heater.running?(t.knob.subText.text="heating",t.knob.subText.color="rgba(255,0,0,.6)"):(t.knob.subText.text=t.low+"° low",t.knob.subText.color="rgba(52,152,219,1)")):(t.knob.barColor="rgba(44,193,133,.6)",t.knob.trackColor="rgba(44,193,133,.1)",t.knob.subText.text="within target",t.knob.subText.color="gray",t.low=null,t.high=null)):(t.knob.trackColor="#ddd",t.knob.barColor="#777",t.knob.subText.text="not running",void(t.knob.subText.color="gray"))},t.changeKettleType=function(t){"hop"==t.type?t.type="water":"grain"==t.type?t.type="hop":"water"==t.type&&(t.type="grain")},t.changeUnits=function(e){_.each(t.kettles,function(n){n.temp.current=i("formatDegrees")(n.temp.current,e),n.temp.target=i("formatDegrees")(n.temp.target,e),n.temp.diff=i("formatDegrees")(n.temp.diff,e),t.updateKnobCopy(n)}),t.chartOptions=s.chartOptions(e)},t.timerRun=function(e,n){e.interval=o(function(){e.up||0!=e.min||0!=e.sec?!e.up&&e.sec>0?e.sec--:e.up&&e.up.sec<59?e.up.sec++:e.up?e.up&&(e.up.sec=0,e.up.min++):(n&&_.each(_.filter(n.timers,{running:!1,min:e.min,queue:!1}),function(e){t.alert(n,e),e.queue=!0,r(function(){t.timerStart(e,n)},6e4)}),e.sec=59,e.min--):(e.running=!1,e.up={min:0,sec:0,running:!0},t.timerRun(e),n&&_.filter(n.timers,{up:{running:!0}}).length==n.timers.length&&t.alert(n,e),o.cancel(e.interval))},1e3)},t.timerStart=function(e,n){e.up&&e.up.running?(e.up.running=!1,o.cancel(e.up.interval)):e.running?(e.running=!1,o.cancel(e.interval)):(e.running=!0,e.queue=!1,t.timerRun(e,n))},t.processTemps=function(){var e=[];_.each(t.kettles,function(n){n.active&&e.push(s.temp(n.pin).then(u,function(e){t.error_message="Could not connect to the Arduino at "+s.domain()}))}),a.all(e).then(function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)},function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)})},t.changeValue=function(e,n,i){p&&r.cancel(p),i?e.temp[n]++:e.temp[n]--,p=r(function(){e.knob.max=e.temp.target+e.temp.diff,t.updateKnobCopy(e)},1e3)},t.processTemps(),t.init(),t.$watch("settings",function(t,e){s.settings("settings",t)},!0),t.$watch("kettles",function(t,e){s.settings("kettles",t)},!0)}]);