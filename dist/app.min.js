var brewBench=angular.module("brewbench",["ui.router","nvd3","ngTouch"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,e,n){n.defaults.useXDomain=!0,n.defaults.headers.common="Content-Type: application/json",delete n.defaults.headers.common["X-Requested-With"],t.state("home",{url:"",templateUrl:"views/monitor.html",controller:"mainCtrl"}).state("otherwise",{url:"*path",templateUrl:"views/not-found.html"})}]);brewBench.filter("moment",function(){return function(t){return t?moment(new Date(t)).fromNow():""}}).filter("formatDegrees",["$filter",function(t){return function(e,n){return"F"==n?t("toFahrenheit")(e):t("toCelsius")(e)}}]).filter("toFahrenheit",function(){return function(t){return Math.round(9*t/5+32)}}).filter("toCelsius",function(){return function(t){return Math.round(5*(t-32)/9)}}).directive("editable",function(){return{restrict:"E",scope:{model:"="},replace:!1,template:'<span><input type="text" ng-model="model" ng-show="edit" ng-enter="edit=false"></input><span ng-show="!edit">{{model}}</span></span>',link:function(t,e,n){t.edit=!1,e.bind("click",function(){t.$apply(t.edit=!0)})}}}).directive("ngEnter",function(){return function(t,e,n){e.bind("keypress",function(e){(13===e.charCode||13===e.keyCode)&&t.$apply(n.ngEnter)})}}),brewBench.factory("BrewService",["$http","$q","$filter",function(t,e,n){return{clear:function(){window.localStorage&&(window.localStorage.removeItem("settings"),window.localStorage.removeItem("kettles"))},settings:function(t,e){if(!window.localStorage)return e;try{if(e)return window.localStorage.setItem(t,JSON.stringify(e));if(window.localStorage.getItem(t))return JSON.parse(window.localStorage.getItem(t))}catch(n){}return e},byteCount:function(t){return encodeURI(t).split(/%..|./).length-1},domain:function(){var t=this.settings("settings");return t&&t.arduinoUrl?t.arduinoUrl:"localhost"==document.location.host?"http://arduino.local":""},temp:function(n,i){var r=e.defer(),o=this.domain()+"/arduino/analog/"+n;return i&&(o+="/"+i),t.get(o,{timeout:1e4}).then(function(t){r.resolve(t.data)},function(t){r.reject(t)}),r.promise},heat:function(n,i){var r=e.defer(),o=this.domain()+"/arduino/digital/"+n;return i&&(o+="/"+i),t.get(o,{timeout:1e4}).then(function(t){r.resolve(t.data)},function(t){r.reject(t)}),r.promise},blink:function(n){var i=e.defer();return t.get(this.domain()+"/arduino/blink/"+n+"/output",{timeout:1e4}).then(function(t){i.resolve(t.data)},function(t){i.reject(t)}),i.promise},chartOptions:function(){return{chart:{type:"lineChart",noData:"Press play on a kettle to start graphing.",height:450,margin:{top:20,right:20,bottom:100,left:65},x:function(t){return t[0]},y:function(t){return t[1]},color:d3.scale.category10().range(),duration:300,useInteractiveGuideline:!0,clipVoronoi:!1,xAxis:{axisLabel:"Time",tickFormat:function(t){return d3.time.format("%I:%M:%S")(new Date(t))},orient:"bottom",tickPadding:20,axisLabelDistance:40,staggerLabels:!0},forceY:[0,220],yAxis:{axisLabel:"Temperature",tickFormat:function(t){return t},orient:"left",showMaxMin:!0,axisLabelDistance:0}}}}}}]),brewBench.controller("mainCtrl",["$scope","$stateParams","$state","$filter","$timeout","$interval","$q","BrewService",function(t,e,n,i,r,o,a,u){function l(e){if(e&&e.temp){var n=t.kettles.filter(function(t){return t.pin==parseInt(e.pin)})[0];"F"==t.settings.unit?n.temp.current=i("toFahrenheit")(e.temp):n.temp.current=Math.round(e.temp),n.values.length>c&&t.kettles.map(function(t){return t.values=[]});var r=new Date;n.values.push([r.getTime(),n.temp.current]),n.temp.current>=n.temp.target+n.temp.diff?(n.high=n.temp.current-n.temp.target,n.low=null,t.tempAlert(n),n.heater.on===!0&&n.heater.running&&u.heat(n.heater.pin,0).then(function(){n.heater.running=null},function(t){})):n.temp.current<=n.temp.target-n.temp.diff?(n.low=n.temp.target-n.temp.current,n.high=null,t.tempAlert(n),n.heater.on!==!0||n.heater.running||u.heat(n.heater.pin,1).then(function(){n.heater.running=new Date},function(t){})):(n.temp.hit=new Date,n.low=null,n.high=null,n.heater.on===!0&&n.heater.running&&u.heat(n.heater.pin,0).then(function(){n.heater.running=null},function(t){}))}}var s=null,c=100;t.chartOptions=u.chartOptions(),t.settings=u.settings("settings")||{pollSeconds:10,unit:"F",sound:!0,notifications:!0,arduinoUrl:"http://arduino.local",storage:"sd"},t.kettles=u.settings("kettles")||[{key:"Boil",pin:0,active:!1,heater:{pin:2,on:!1,running:!1},timer:{min:60,sec:0,running:!1},temp:{hit:!1,current:0,target:200,diff:5},volume:5,values:[]},{key:"Hot Liquor",pin:1,active:!1,heater:{pin:3,on:!1,running:!1},temp:{hit:!1,current:0,target:200,diff:5},volume:5,values:[]},{key:"Mash",pin:2,active:!1,heater:{pin:4,on:!1,running:!1},timer:{min:60,sec:0,running:!1},temp:{hit:!1,current:0,target:200,diff:5},volume:5,values:[]}],t.addKettle=function(){t.kettles.length<5&&t.kettles.unshift({key:"New Kettle",pin:t.kettles.length,active:!1,heater:{pin:5,on:!1,running:!1},temp:{hit:!1,current:0,target:200,diff:5},volume:5,values:[]})},t.startStopKettle=function(t){t.active=!t.active,!t.active&&t.heater.running&&u.heat(t.heater.pin,0).then(function(){t.heater.running=null,t.heater.on=!1},function(t){})},t.startStopKettleHeat=function(t){t.heater.on=!t.heater.on,!t.heater.on&&t.heater.running&&u.heat(t.heater.pin,0).then(function(){t.heater.running=null},function(t){})},t.clearKettles=function(){u.clear()},t.tempAlert=function(e){if(!e||e.temp.hit){if("vibrate"in navigator&&navigator.vibrate([500,300,500]),t.settings.sound===!0){var n=new Audio("audio/error.mp3");n.play()}if(t.settings.notifications&&"Notification"in window){var i,r="img/brewbench-logo-45.png";e&&e.high?i="Your "+e.key+" kettle is "+e.high+" degrees too hot":e&&e.low?i="Your "+e.key+" kettle is "+e.low+" degrees too cold":e||(i="Testing Alerts, you are ready to go, click play on a kettle."),s&&s.close(),"granted"===Notification.permission?i&&(s=new Notification("BrewBench",{body:i,icon:r})):"denied"!==Notification.permission&&Notification.requestPermission(function(t){"granted"===t&&i&&(s=new Notification("BrewBench",{body:i,icon:r}))})}}},t.tempCheck=function(t){},t.changeUnits=function(e){for(k in t.kettles)t.kettles[k].temp.current=i("formatDegrees")(t.kettles[k].temp.current,e),t.kettles[k].temp.target=i("formatDegrees")(t.kettles[k].temp.target,e),t.kettles[k].temp.diff=i("formatDegrees")(t.kettles[k].temp.diff,e)},t.timerRun=function(e){t.kettles[e].interval=o(function(){0==t.kettles[e].timer.min&&0==t.kettles[e].timer.sec?o.cancel(t.kettles[e].interval):t.kettles[e].timer.sec>0?t.kettles[e].timer.sec--:(t.kettles[e].timer.sec=59,t.kettles[e].timer.min--)},1e3)},t.timerStart=function(e){t.kettles[e].timer.running?(t.kettles[e].timer.running=!1,o.cancel(t.kettles[e].interval)):(t.kettles[e].timer.running=!0,t.timerRun(e))},t.processTemps=function(){var e=[];for(k in t.kettles)t.kettles[k].active&&e.push(u.temp(t.kettles[k].pin).then(l));a.all(e).then(function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)},function(e){r(function(){t.processTemps()},1e3*t.settings.pollSeconds)})},t.changeValue=function(e,n,i){i?t.kettles[e][n]++:t.kettles[e][n]--},t.processTemps(),t.tempAlert();for(k in t.kettles)t.kettles[k].timer&&t.kettles[k].timer.running&&t.timerRun(k);t.$watchCollection("settings",function(t,e){u.settings("settings",t)}),t.$watch("kettles",function(t,e){u.settings("kettles",t)},!0)}]);